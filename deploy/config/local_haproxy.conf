################################################################
# Licensed Materials - Property of IBM
# "Restricted Materials of IBM"
# Copyright IBM Corp. 2025 ALL RIGHTS RESERVED
################################################################


# HAProxy for fronting web server, reverse proxy to MVP2 & CIMF cluster
#
http-errors gfmerrors
    errorfile 404 /etc/haproxy/errors/404.http

global
    daemon
    maxconn 256
    tune.bufsize 32768
    tune.maxrewrite 4096

defaults
    mode http
    timeout connect 10s
    timeout client 900s
    timeout server 900s
    # never fail on address resolution
    default-server init-addr last,libc,none

# Geostudio HTTP server with mini-backend
frontend in-geostudio-backend
    bind *:8090
    acl studiogatewayv2path path_beg /studio-gateway/v2/
    use_backend studio-gateway if studiogatewayv2path
    acl studiogatewaypath path_beg /studio-gateway/
    use_backend studio-gateway if studiogatewaypath
    acl geofmgeoserverpath path_beg /geofm-geoserver/
    http-request del-header Cookie if geofmgeoserverpath
    use_backend geofm-geoserver if geofmgeoserverpath

    acl mlflowpath path_beg /mlflow/
    acl mlflow_ajax_api path_beg /mlflow/ajax-api/
    acl mlflow_runs_get path_beg /mlflow/ajax-api/2.0/mlflow/runs/get
    acl mlflow_model_versions_search path_beg /mlflow/ajax-api/2.0/mlflow/model-versions/search
    acl mlflow_experiments_get path_beg /mlflow/ajax-api/2.0/mlflow/experiments/get
    acl mlflow_metrics_get_history_bulk_interval path_beg /mlflow/ajax-api/2.0/mlflow/metrics/get-history-bulk-interval
    acl mlflow_metrics_get_history path_beg /mlflow/ajax-api/2.0/mlflow/metrics/get-history
    acl mlflow_traces path_beg /mlflow/ajax-api/2.0/mlflow/traces
    acl mlflow_artifacts_list path_beg /mlflow/ajax-api/2.0/mlflow/artifacts/list
    acl mlflow_get_artifact path_beg /mlflow/get-artifact

    use_backend mlflow_deny if mlflow_ajax_api !mlflow_runs_get !mlflow_model_versions_search !mlflow_experiments_get !mlflow_metrics_get_history_bulk_interval !mlflow_traces !mlflow_artifacts_list !mlflow_get_artifact !mlflow_metrics_get_history
    use_backend mlflow if mlflowpath

    use_backend geostudio-env-file if { path /env.json }
    default_backend geostudio-backend
    errorfiles gfmerrors
    http-response return status 404 default-errorfiles if { status 404 }

# Serve env.json from a hardcoded folder in containers
backend geostudio-env-file
    http-request del-header Cookie
    http-request return status 200 content-type "application/json" file "/home/geostudio/env.json" hdr "cache-control" "no-cache"

# Geostudio static serving of UI assets
backend geostudio-backend
    http-request del-header Cookie
    # Add header for which server responded
    http-response set-header X-Server %s
    # http-response set-header Referrer-Policy no-referrer # this breaks mapbox basemaps
    http-response set-header X-Content-Type-Options nosniff
    http-response set-header Content-Security-Policy "default-src 'self'; style-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-eval' https://dev.virtualearth.net blob:; connect-src *; img-src data: blob: *; worker-src 'self' data: blob:; frame-ancestors 'self';"

    # Strip out the index.html part from root URL
    http-request replace-path ^(\/+)$ \/index.html

    # redirect 404's to home page (caveat: makes debugging 404 fetch calls in the browser difficult)
    #http-response set-header Location / if { status eq 404 }
    #http-response set-status 302 if { status eq 404 }

    # Add gzip compression
    compression algo gzip
    compression type text/html text/plain text/css application/json text/javascript text/x-javascript application/x-javascript

    # Althttpd server instances
    server server1 127.0.0.1:8003 maxconn 32

# Reverse proxy for Studio Gateway APIs (to add CORS headers)
backend studio-gateway
    http-request replace-path (/studio-gateway/)(.*) /\2
    http-request set-header Host ${STUDIO_GATEWAY_API_URL}
    http-response set-header Access-Control-Allow-Origin "*"
    http-response set-header X-Content-Type-Options nosniff
    http-response set-header Content-Security-Policy "default-src 'self'; style-src 'self' 'unsafe-inline'; script-src 'self'; connect-src *; img-src data: blob: *; worker-src 'self' data: blob:; frame-ancestors 'self';"

    # Add gzip compression
    compression algo gzip
    compression type text/html text/plain text/css application/json text/javascript text/x-javascript application/x-javascript

    # Instance of MVP2 to proxy.
    server server1 ${STUDIO_GATEWAY_API_URL} maxconn 32

# Reverse proxy for Geoserver (to add CORS headers)
backend geofm-geoserver
    http-request del-header Cookie
    http-request replace-path (/geofm-geoserver/)(.*) /\2
    http-request set-header Host ${GEOFM_GEOSERVER}
    http-response set-header Access-Control-Allow-Origin "*"
    http-response set-header X-Content-Type-Options nosniff
    http-response set-header Content-Security-Policy "default-src 'self'; style-src 'self' 'unsafe-inline'; script-src 'self'; connect-src *; img-src data: blob: *; worker-src 'self' data: blob:; frame-ancestors 'self';"
    http-response set-header Cache-Control "max-age=43200"

    # Add gzip compression
    compression algo gzip
    compression type text/html text/plain text/css application/json text/javascript text/x-javascript application/x-javascript

    # Instance of MVP2 to proxy.
    server server1 ${GEOFM_GEOSERVER} maxconn 32

# Reverse proxy for mlflow (to add CORS headers)
backend mlflow
    http-request del-header Cookie
    http-request replace-path (/mlflow/)(.*) /\2
    http-request set-header Host ${MLFLOW_URL}
    http-response set-header Access-Control-Allow-Origin "*"
    http-response set-header X-Content-Type-Options nosniff
    http-response set-header Content-Security-Policy "default-src 'self'; style-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-eval'; connect-src *; img-src data: blob: *; worker-src 'self' data: blob:; frame-ancestors 'self';"

    # Add gzip compression
    compression algo gzip
    compression type text/html text/plain text/css application/json text/javascript text/x-javascript application/x-javascript

    # Instance of MVP2 to proxy.
    server server1 ${MLFLOW_URL} maxconn 32


backend mlflow_deny
    http-request del-header Cookie
    mode http
    http-request deny
